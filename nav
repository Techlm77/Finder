#!/bin/bash

# Version of the nav script
NAV_VERSION="1.0.1"

# Function to compare version numbers
compare_versions() {
    if [[ $1 == $2 ]]; then
        echo 0  # Versions are the same
    else
        local IFS=.
        local i ver1=($1) ver2=($2)
        for ((i = 0; i < 3; i++)); do
            if [[ -z ${ver1[i]} ]]; then
                ver1[i]=0
            fi
            if [[ -z ${ver2[i]} ]]; then
                ver2[i]=0
            fi
            if ((10#${ver1[i]} < 10#${ver2[i]})); then
                echo -1  # Local version is lower
                return
            elif ((10#${ver1[i]} > 10#${ver2[i]})); then
                echo 1   # Local version is higher
                return
            fi
        done
        echo 0  # Versions are the same
    fi
}

# Function to navigate to the found location
navigate_to() {
    local target="$1"
    cd "$target"
    echo "You are now in: $(pwd)"
}

# Function to uninstall nav
uninstall_nav() {
    rm -f /usr/bin/nav
    echo "nav has been uninstalled"
}

# Function to update nav
update_nav() {
    local local_version remote_version

    # Check local version
    local_version=$(nav --version)
    if [ -z "$local_version" ]; then
        echo "Error: Unable to determine local version."
        exit 1
    fi

    # Check remote version on GitHub
    remote_version=$(curl -s https://raw.githubusercontent.com/Techlm77/Finder/master/nav | grep -o 'NAV_VERSION="[0-9.]*"')

    if [ -z "$remote_version" ]; then
        echo "Error: Unable to determine remote version."
        exit 1
    fi

    # Extract version numbers
    local_version="${local_version#NAV_VERSION=}"
    local_version="${local_version%\"}"
    remote_version="${remote_version#NAV_VERSION=}"
    remote_version="${remote_version%\"}"

    # Compare versions
    comparison_result=$(compare_versions "$local_version" "$remote_version")

    if [ "$comparison_result" -eq 0 ]; then
        echo "You are already up to date (Version $local_version)."
    elif [ "$comparison_result" -eq -1 ]; then
        echo "Updating to the latest version (Version $remote_version)..."
        # Download the nav script from GitHub and save it to /usr/bin/nav
        curl -o /usr/bin/nav https://raw.githubusercontent.com/Techlm77/Finder/master/nav
        chmod +x /usr/bin/nav
        echo "nav has been updated to Version $remote_version"
    else
        echo "Your version (Version $local_version) is newer than the remote version."
    fi
}

# Check command-line arguments
if [ "$1" == "--uninstall" ]; then
    uninstall_nav
elif [ "$1" == "--update" ]; then
    update_nav
else
    # Prompt the user for the search term
    read -p "Enter the file or folder name: " search_term

    # Search for the file or folder starting from the root directory '/'
    result=$(find / -name "$search_term" 2>/dev/null)

    # Check if the search was successful
    if [ -n "$result" ]; then
        echo "Found: $result"
        # Ask the user if they want to navigate to the found location
        read -p "Do you want to navigate to this location? (y/n): " choice
        if [ "$choice" == "y" ] || [ "$choice" == "Y" ]; then
            navigate_to "$(dirname "$result")"
        fi
    else
        echo "File or folder not found."
    fi

    # Display the script version
    echo "nav version: $NAV_VERSION"
fi
